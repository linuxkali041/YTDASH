<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äì YTDash</title>
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="/static/css/admin.css?v=2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="logo" style="margin-bottom: var(--spacing-xl);">
                <span class="logo-icon"><i class="fab fa-youtube" style="color: var(--yt-red);"></i></span>
                <span>YTDash <span style="font-weight: 300; font-size: 0.8em;">Admin</span></span>
            </div>

            <nav class="admin-nav">
                <a href="/admin" class="admin-nav-item active">
                    <span class="icon"><i class="fas fa-chart-line"></i></span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users.html" class="admin-nav-item">
                    <span class="icon"><i class="fas fa-users"></i></span>
                    <span>Users</span>
                </a>
                <a href="/admin/settings.html" class="admin-nav-item">
                    <span class="icon"><i class="fas fa-cog"></i></span>
                    <span>Settings</span>
                </a>
                <a href="/admin/downloads.html" class="admin-nav-item">
                    <span class="icon"><i class="fas fa-cloud-download-alt"></i></span>
                    <span>Downloads</span>
                </a>
                <a href="/admin/logs.html" class="admin-nav-item">
                    <span class="icon"><i class="fas fa-clipboard-list"></i></span>
                    <span>Audit Logs</span>
                </a>
                <hr style="margin: var(--spacing-lg) 0; border-color: var(--border);">
                <a href="/" class="admin-nav-item">
                    <span class="icon"><i class="fas fa-home"></i></span>
                    <span>Main Site</span>
                </a>
                <a href="#" id="logoutBtn" class="admin-nav-item">
                    <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span>Logout</span>
                </a>
            </nav>

            <!-- Theme Switcher -->
            <div style="margin-top: auto; padding-top: var(--spacing-lg);">
                <div class="theme-toggle" role="group" style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button class="theme-option active" data-theme="light" title="Light theme"
                        style="padding: 0.5rem; border-radius: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border); cursor: pointer;">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button class="theme-option" data-theme="dark" title="Dark theme"
                        style="padding: 0.5rem; border-radius: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border); cursor: pointer;">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="theme-option" data-theme="amoled" title="AMOLED"
                        style="padding: 0.5rem; border-radius: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border); cursor: pointer;">
                        <i class="fas fa-circle"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <div>
                    <h1 class="admin-title">Dashboard</h1>
                    <p style="color: var(--text-secondary);">System overview and statistics</p>
                </div>
                <div>
                    <span id="currentUser" style="color: var(--text-secondary);"></span>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Total Users</span>
                        <span class="stat-card-icon"><i class="fas fa-users"></i></span>
                    </div>
                    <div class="stat-card-value" id="totalUsers">-</div>
                    <div class="stat-card-change"><span id="activeUsers">-</span> active</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Total Downloads</span>
                        <span class="stat-card-icon"><i class="fas fa-cloud-download-alt"></i></span>
                    </div>
                    <div class="stat-card-value" id="totalDownloads">-</div>
                    <div class="stat-card-change"><span id="activeDownloads">-</span> active</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">YouTube Accounts</span>
                        <span class="stat-card-icon"><i class="fab fa-youtube"></i></span>
                    </div>
                    <div class="stat-card-value" id="totalCredentials">-</div>
                    <div class="stat-card-change">Total credentials</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Storage Used</span>
                        <span class="stat-card-icon"><i class="fas fa-hdd"></i></span>
                    </div>
                    <div class="stat-card-value" id="storageUsed">-</div>
                    <div class="stat-card-change">Across all users</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                <div class="flex gap-md">
                    <button class="btn btn-primary" onclick="window.location.href='/admin/users.html'">
                        <span><i class="fas fa-users"></i></span>
                        <span>Manage Users</span>
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='/admin/settings.html'">
                        <span><i class="fas fa-cog"></i></span>
                        <span>Configure Settings</span>
                    </button>
                    <button class="btn btn-outline" onclick="window.location.href='/admin/logs.html'">
                        <span><i class="fas fa-clipboard-list"></i></span>
                        <span>View Logs</span>
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title">Recent Activity</h2>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearActivity()">
                        <i class="fas fa-trash-alt"></i> Clear Activity
                    </button>
                </div>
                <div id="recentLogs">
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-clipboard-check"></i></div>
                        <div class="empty-state-title">Loading activity...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script src="/static/js/admin/adminAPI.js?v=2"></script>
    <script src="/static/js/admin/adminTheme.js?v=1"></script>
    <script>
        // Simple toast function
        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Check Authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');

            if (!token || user.role !== 'admin') {
                window.location.href = '/login';
                return false;
            }

            document.getElementById('currentUser').textContent = `üë§ ${user.username}`;
            return true;
        }

        // Load Stats
        async function loadStats() {
            try {
                const stats = await adminAPI.getStats();

                document.getElementById('totalUsers').textContent = stats.total_users;
                document.getElementById('activeUsers').textContent = stats.active_users;
                document.getElementById('totalDownloads').textContent = stats.total_downloads;
                document.getElementById('activeDownloads').textContent = stats.active_downloads;
                document.getElementById('totalCredentials').textContent = stats.total_credentials;

                // Format storage
                const storageGB = (stats.total_storage_used / 1073741824).toFixed(2);
                document.getElementById('storageUsed').textContent = `${storageGB} GB`;

            } catch (error) {
                console.error('Failed to load stats:', error);
                showToast('error', 'Error', 'Failed to load statistics');
            }
        }

        // Load Recent Logs
        async function loadRecentLogs() {
            try {
                const logs = await adminAPI.getLogs(0, 10);
                const container = document.getElementById('recentLogs');

                if (logs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="empty-state-title">No recent activity</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = logs.map(log => `
                    <div class="log-entry">
                        <div class="log-header">
                            <span class="log-action">${log.action.replace(/_/g, ' ')}</span>
                            <span class="log-time">${new Date(log.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="log-details">
                            User: ${log.username} | ${log.resource_type || 'system'}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load logs:', error);
            }
        }

        async function clearActivity() {
            if (!confirm('Are you sure you want to clear all recent activity logs? This cannot be undone.')) {
                return;
            }

            try {
                await adminAPI.clearLogs();
                showToast('success', 'Activity Cleared', 'All audit logs have been deleted.');
                loadRecentLogs(); // Reload to show empty state/new log
            } catch (error) {
                showToast('error', 'Error', 'Failed to clear activity logs.');
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        // Initialize
        if (checkAuth()) {
            loadStats();
            loadRecentLogs();

            // Refresh stats every 30 seconds
            setInterval(loadStats, 30000);
        }
    </script>
</body>

</html>